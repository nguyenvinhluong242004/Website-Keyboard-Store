<ul class="breadcrumb" style="margin: 7px; margin-left: 100px;">
    <li>
        <a href="/" style="text-decoration: none; color: blue;"><span>Trang chủ</span></a>
        <span class="mr_lr">&nbsp;/&nbsp;</span>
    </li>
    <li><strong><span>Tài khoản</span></strong></li>
</ul>
<div class="container py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card shadow-sm mb-4" style="height: 100%; min-height: 360px;">
                <div class="card-body-ac text-center" style="height: 120px; border-bottom: 1px solid black;">
                    <img src="image/default/image.png" alt="Avatar người dùng" class="rounded-circle mb-2"
                        style="height: 75px;">
                    <h5 class="card-title" id="txtname"></h5>
                </div>
                <div>
                    <ul class="list-group" style="margin-top: 0px; border-radius: 0%;">
                        <li class="list-group-item active" data-section="accountInfo" style="border: none;">Thông tin
                            tài khoản</li>
                        <li class="list-group-item" data-section="addressBook" style="border: none;">Sổ địa chỉ</li>
                        <li class="list-group-item" data-section="orderManagement" style="border: none;">Quản lý đơn
                            hàng</li>
                        <li class="list-group-item" id="logoutBtn" style="border: none;">Đăng xuất</li>
                    </ul>
                </div>
                <div>

                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <div id="accountInfo" class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Thông tin tài khoản</h5>
                </div>
                <div class="card-body">
                    <form id="accountForm">
                        <div class="row align-items-center mb-3">
                            <label class="col-md-3 col-form-label">Họ Tên</label>
                            <div class="col-md-9">
                                <input type="text" class="form-control" id="username" placeholder="Họ tên">
                            </div>
                        </div>
                        <div class="row align-items-center mb-3">
                            <label class="col-md-3 col-form-label">Số điện thoại</label>
                            <div class="col-md-9">
                                <div class="d-flex">
                                    <input type="text" class="form-control" id="phone" placeholder="Số điện thoại">
                                </div>
                            </div>
                        </div>
                        <div class="row align-items-center mb-3">
                            <label class="col-md-3 col-form-label">Email</label>
                            <div class="col-md-9">
                                <div class="d-flex">
                                    <input type="email" class="form-control" id="email" placeholder="Email" disabled>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-danger" id="changeinfo">Lưu thay đổi</button>
                    </form>
                </div>
            </div>

            <div id="addressBook" class="card shadow-sm d-none">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Sổ địa chỉ</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary" id="addAddressBtn">Thêm địa chỉ mới</button>
                    <div id="addressList"></div>
                </div>
            </div>

            <div id="orderManagement" class="card shadow-sm d-none">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Quản lý đơn hàng</h5>
                </div>
                <div class="card-body">
                    <table id="order-table" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Mã đơn hàng</th>
                                <th>Ngày đặt</th>
                                <th>Tình trạng</th>
                                <th>Phương thức thanh toán</th>
                                <th>Tổng số tiền</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Nội dung đơn hàng sẽ được thêm ở đây -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addressModalLabel">Thêm/Sửa địa chỉ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addressForm">
                        <div class="mb-3">
                            <label for="street" class="form-label">Đường</label>
                            <input type="text" class="form-control" id="street" placeholder="Nhập đường">
                        </div>
                        <div class="mb-3">
                            <label for="ward" class="form-label">Phường</label>
                            <input type="text" class="form-control" id="ward" placeholder="Nhập phường">
                        </div>
                        <div class="mb-3">
                            <label for="district" class="form-label">Quận</label>
                            <input type="text" class="form-control" id="district" placeholder="Nhập quận">
                        </div>
                        <div class="mb-3">
                            <label for="province" class="form-label">Tỉnh</label>
                            <input type="text" class="form-control" id="province" placeholder="Nhập tỉnh">
                        </div>
                        <input type="hidden" id="addressId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="saveAddressBtn">Lưu</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationModalLabel">Thông báo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="notificationMessage">Nội dung thông báo sẽ hiển thị ở đây.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal xem chi tiết đơn hàng -->
    <div class="modal fade" id="order-detail-modal" tabindex="-1" aria-labelledby="orderDetailModalLabel"
        aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailModalLabel">Chi tiết đơn hàng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div>
                        <strong>Mã đơn hàng:</strong> <span id="modal-order-id"></span><br>
                        <strong>Ngày đặt:</strong> <span id="modal-order-date"></span><br>
                        <strong>Tình trạng:</strong> <span id="modal-order-status"></span><br>
                        <strong>Phương thức thanh toán:</strong> <span id="modal-payment-method"></span><br>
                        <strong>Tổng số tiền:</strong> <span id="modal-total-amount"></span><br>
                    </div>
                    <hr>
                    <h6>Danh sách sản phẩm:</h6>
                    <div id="modal-products-list" class="d-flex flex-wrap">
                        <!-- Danh sách sản phẩm sẽ được hiển thị ở đây -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function getItem(productId, type) {
        if (type === 1) {
            window.location.href = `/detail-product/instock/${productId}`;
        }
        else if (type === 2) {
            window.location.href = `/detail-group-by/${productId}`;
        }
    }
    $(document).ready(function () {
        let section = 'accountInfo';
        let dataUser = {};
        let addressList = [];
        let orderList = [];

        // Hiển thị danh sách địa chỉ
        function renderAddressList() {
            let addressHtml = '';
            addressList.forEach((addr, index) => {
                addressHtml += `
                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                    <span>${addr.street}, ${addr.ward}, ${addr.district}, ${addr.province}</span>
                    <div>
                        <button class="btn btn-sm btn-warning editAddressBtn" data-id="${addr.id}">Sửa</button>
                        <button class="btn btn-sm btn-danger deleteAddressBtn" data-id="${addr.id}">Xóa</button>
                    </div>
                </div>`;
            });
            $('#addressList').html(addressHtml);
        }

        // Xử lý thêm địa chỉ mới
        $('#addAddressBtn').on('click', function () {
            $('#addressModalLabel').text('Thêm địa chỉ mới');
            $('#addressForm')[0].reset();
            $('#addressId').val('');
            $('#addressModal').modal('show');
        });

        // Xử lý lưu địa chỉ
        $('#saveAddressBtn').on('click', function () {
            const street = $('#street').val();
            const ward = $('#ward').val();
            const district = $('#district').val();
            const province = $('#province').val();
            const addressId = $('#addressId').val();

            if (street === '' || ward === '' || district === '' || province === '') {

                $('#addressModal').modal('hide');
                showNotification("Vui lòng nhập đầy đủ thông tin");
                return;
            }

            $.ajax({
                url: '/account/add-address/api',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    id: addressId,
                    province: province,
                    district: district,
                    ward: ward,
                    street: street
                }),
                success: function (response) {
                    console.log(response.data)
                    addressList = response.data;
                    $('#addressModal').modal('hide');
                    renderAddressList();
                    showNotification("Đã cập nhật sổ địa chỉ.");
                },
                error: function (error) {
                    console.error("Có lỗi khi lấy thông tin: ", error);
                    showNotification("Có lỗi khi lấy thông tin. Vui lòng thử lại.");
                }
            });
        });

        // Xử lý sửa địa chỉ
        $(document).on('click', '.editAddressBtn', function () {
            const id = $(this).data('id');
            const addr = addressList.find(item => item.id === id);

            $('#street').val(addr.street);
            $('#ward').val(addr.ward);
            $('#district').val(addr.district);
            $('#province').val(addr.province);
            $('#addressId').val(id);

            $('#addressModalLabel').text('Chỉnh sửa địa chỉ');
            $('#addressModal').modal('show');
        });

        // Xử lý xóa địa chỉ
        $(document).on('click', '.deleteAddressBtn', function () {
            const id = $(this).data('id');
            $.ajax({
                url: '/account/delete-address/api',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    id: id,
                }),
                success: function (response) {
                    console.log(response.data)
                    addressList = response.data;
                    $('#addressModal').modal('hide');
                    renderAddressList();
                    showNotification("Đã cập nhật sổ địa chỉ.");
                },
                error: function (error) {
                    console.error("Có lỗi khi lấy thông tin: ", error);
                    showNotification("Có lỗi khi lấy thông tin. Vui lòng thử lại.");
                }
            });
        });

        getInfor();
        $('.list-group-item').on('click', function () {
            $(`#${section}`).addClass('d-none');
            section = $(this).data('section');
            if (section === 'none') {
                return;
            }

            $('.list-group-item').removeClass('active');
            $(this).addClass('active');

            $(`#${section}`).removeClass('d-none');

            if (section === 'accountInfo') {
                getInfor();
            } else if (section === 'addressBook') {
                $.ajax({
                    url: '/account/get-address/api',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                    }),
                    success: function (response) {
                        console.log(response.data)
                        addressList = response.data;

                        // Render ban đầu
                        renderAddressList();
                    },
                    error: function (error) {
                        console.error("Có lỗi khi lấy thông tin: ", error);
                        showNotification("Có lỗi khi lấy thông tin. Vui lòng thử lại.");
                    }
                });
            } else if (section === 'orderManagement') {
                $.ajax({
                    url: '/account/get-orders/api',
                    method: 'GET',
                    contentType: 'application/json',
                    success: function (response) {
                        orderList = response.data; // Dữ liệu trả về từ API
                        const tableBody = $("#order-table tbody");
                        tableBody.empty(); // Xóa nội dung cũ nếu có
                        console.log(orderList)
                        orderList.forEach((order, index) => {
                            const row = `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${order.orderid}</td>
                                    <td>${new Date(order.orderdate).toLocaleDateString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' })}</td>
                                    <td>${order.orderstatus}</td>
                                    <td>${order.paymentmethod}</td>
                                    <td>$${order.totalamount.toFixed(2)}</td>
                                    <td>
                                        <button class="btn btn-primary btn-sm view-detail-btn" data-order='${index}'>
                                            Xem chi tiết
                                        </button>
                                    </td>
                                </tr>
                            `;
                            tableBody.append(row);
                        });

                        // Xử lý nút "Xem chi tiết"
                        $(".view-detail-btn").on("click", function () {
                            const order = orderList[($(this).data("order"))];

                            // Hiển thị thông tin chi tiết đơn hàng
                            $("#modal-order-id").text(order.orderid);
                            $("#modal-order-date").text(new Date(order.orderdate).toLocaleDateString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' }));
                            $("#modal-order-status").text(order.orderstatus);
                            $("#modal-payment-method").text(order.paymentmethod);
                            $("#modal-total-amount").text(`$${order.totalamount.toFixed(2)}`);

                            // Hiển thị danh sách sản phẩm
                            const productsList = $("#modal-products-list");
                            productsList.empty();
                            order.products.forEach(product => {
                                let typeName = '[Instock] ';
                                if (product.type === 2){
                                    typeName = '[Group By] ';
                                }
                                if (!product.type){
                                    typeName = '[Đã xóa] ';
                                }
                                const productHTML = `
                                    <div class="product-item d-flex align-items-center m-2 p-2 border" style="width: calc(50% - 1rem);">
                                        <img onclick="getItem(${product.productid}, ${product.type})" src="${product.firstimage}" alt="${product.productname}" style="cursor: pointer; width: 70px; height: 70px; object-fit: cover; margin-right: 10px;">
                                        <div>
                                            <div><strong>${typeName}${product.productname}</strong></div>
                                            <div>Số lượng: ${product.quantity}</div>
                                            <div>Giá: $${product.unitprice.toFixed(2)}</div>
                                        </div>
                                    </div>
                                `;
                                productsList.append(productHTML);
                            });

                            // Hiển thị modal
                            $("#order-detail-modal").modal("show");
                        });
                    },
                    error: function (error) {
                        console.error("Có lỗi khi lấy thông tin: ", error);
                        showNotification("Có lỗi khi lấy thông tin. Vui lòng thử lại.");
                    }
                });
            }
        });

        $('#logoutBtn').on('click', function () {
            $.post('/account/logout', function (data) {
                if (data.success) {
                    showNotification("Đăng xuất thành công");
                    window.location.reload();
                }
            });
        });
        $('#changeinfo').on('click', function () {
            const regexUsername = /^[a-zA-Z_]*$/;
            const regexSDT = /^0[0-9]{9}$/;
            console.log($('#username').val())
            if (!$('#phone').val().match(regexSDT)) {
                alert('Số điện thoại không hợp lệ!');
                return;
            }
            if ($('#username').val() === '') {
                alert('Tên không hợp lệ!');
                return;
            }
            $.ajax({
                url: '/account/change-info/api',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    userid: dataUser.userid,
                    username: $('#username').val(),
                    phone: $('#phone').val(),
                    email: $('#email').val(),
                }),
                success: function (response) {
                    console.log(response.dataUser)
                    dataUser = response.dataUser;
                    $('#txtname').text(response.dataUser.username);
                    $('#username').val(response.dataUser.username);
                    $('#phone').val(response.dataUser.phone);
                    $('#email').val(response.dataUser.email);
                    showNotification("Thay đổi thông tin thành công");

                },
                error: function (error) {
                    console.error("Có lỗi khi thay đổi thông tin: ", error);
                    showNotification("Có lỗi khi thay đổi thông tin. Vui lòng thử lại.");
                }
            });
        });
        function getInfor() {
            $.ajax({
                url: '/account/get-info/api',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                }),
                success: function (response) {
                    console.log(response.dataUser)
                    dataUser = response.dataUser;
                    $('#txtname').text(response.dataUser.username);
                    $('#username').val(response.dataUser.username);
                    $('#phone').val(response.dataUser.phone);
                    $('#email').val(response.dataUser.email);
                },
                error: function (error) {
                    console.error("Có lỗi khi lấy thông tin: ", error);
                    showNotification("Có lỗi khi lấy thông tin. Vui lòng thử lại.");
                }
            });
        }

        function showNotification(message) {
            $('#notificationMessage').text(message); // Cập nhật nội dung thông báo
            $('#notificationModal').modal('show');   // Hiển thị modal
        }

    });
</script>